/**
 * Iran Bill Validator
 * Returns:
 *  - [-1] → invalid bill number
 *  - [-2] → invalid payment ID
 *  - [billNumber, paddedPaymentId, fee, type]
 */
function IranBill(billNumber, paymentId) {
  const BILL_LENGTH = 13;
  const MIN_PAYMENT_ID = 7;

  const ERR_BILL = [-1];
  const ERR_PAYMENT = [-2];

  const WEIGHTS = [
    2,3,4,5,6,7, 2,3,4,5,6,7,
    2,3,4,5,6,7, 2,3,4,5,6,7,
    2,3
  ];

  // Input validation
  if (typeof billNumber !== "string" || billNumber.length !== BILL_LENGTH) {
    return ERR_BILL;
  }

  if (typeof paymentId !== "string" || paymentId.length < MIN_PAYMENT_ID) {
    return ERR_PAYMENT;
  }

  const paddedPaymentId = paymentId.padStart(BILL_LENGTH, "0");

  // Convert to digit arrays only once
  const billDigits = Array.from(billNumber, Number);
  const paymentDigits = Array.from(paddedPaymentId, Number);

  // Bill type at pos 12
  const type = billDigits[11];

  /**
   * Generic checksum calculator.
   * Accepts normal left-to-right digits with a reverseIndex reference.
   * This avoids creating reversed arrays.
   */
  const checksum = (digits, reverseIndex, start, length) => {
    let sum = 0;

    for (let i = 0; i < length; i++) {
      const idx = reverseIndex - (start + i);
      sum += digits[idx] * WEIGHTS[i];
    }

    const mod = 11 - (sum % 11);
    return mod > 9 ? 0 : mod;
  };

  const billLast = BILL_LENGTH - 1;
  const payLast  = BILL_LENGTH - 1;

  // 1) Bill checksum
  if (checksum(billDigits, billLast, 1, 12) !== billDigits[billLast]) {
    return ERR_BILL;
  }

  // 2) Payment ID checksum
  if (checksum(paymentDigits, payLast, 2, 11) !== paymentDigits[payLast - 1]) {
    return ERR_PAYMENT;
  }

  // 3) Combined checksum digits
  const combinedString = billNumber + paddedPaymentId.slice(5, 12);
  const combinedDigits = Array.from(combinedString, Number);
  const combLast = combinedDigits.length - 1;

  if (checksum(combinedDigits, combLast, 0, 20) !== paymentDigits[payLast]) {
    return ERR_PAYMENT;
  }

  // 4) Calculate fee
  const fee = Number(paddedPaymentId.slice(0, 8)) * 1000;
  if (!fee) return ERR_PAYMENT;

  return [billNumber, paddedPaymentId, fee, type];
}
